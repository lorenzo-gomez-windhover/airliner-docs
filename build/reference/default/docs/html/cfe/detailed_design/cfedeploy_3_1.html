<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Core Flight Executive Detailed Design: MCP750 / vxWorks 6.4 Platform</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Core Flight Executive Detailed Design
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="cfedeployguide.html">cFE Deployment Guide</a></li><li class="navelem"><a class="el" href="cfedeploy_3.html">Target Specific Instructions</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">MCP750 / vxWorks 6.4 Platform </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>On the MCP750/vxWorks 6.4 platform, the cFE Core is built as a dynamic loadable vxWorks module, rather than being linked to the vxWorks kernel/BSP. The cFE core is loaded into the compact flash disk on the MCP750, so it can be started from a vxWorks shell or startup script after the kernel comes up. In order to successfully run the cFE core and cFE Applications on the MCP750, the kernel must have a few items configured to support the cFE</p>
<center> <h4>cFE Core Configuration on the MCP750 PPC Board </h4>
</center><center> </center> <center> <b> cfe-config.mak Settings </b> </center> <table  align="CENTER">
<tr>
<td><b>cfe-config.mak variable </b> </td><td><b>Required selection </b> </td><td><b>Notes</b> </td></tr>
<tr>
<td>HWARCH </td><td>PPC </td></tr>
<tr>
<td>PLATFORM </td><td>mcp750 </td></tr>
<tr>
<td>OS </td><td>vxworks6 </td></tr>
<tr>
<td>BSP </td><td>vxworks6.4 </td></tr>
</table>
<center> <h4>File System Mappings on the MCP750 PPC Board </h4>
</center><center> </center><p>The cFE uses the following file system mappings for the MCP750 PPC Board. The file system mappings are defined in the <code><a class="el" href="bsp__voltab_8c.html">bsp_voltab.c</a></code> file in the <code>arch/ppc/mcp750/vxworks6.2/bsp</code> directory:</p>
<center> <b> OSAL File System Mappings </b> </center> <table  width="100%">
<tr>
<td><b> cFE "device" </b> </td><td><b> File System Type </b> </td><td><b> cFE Path </b> </td><td><b> Host Path </b> </td><td><b> Notes </b> </td></tr>
<tr>
<td>/ramdev0 </td><td>Real RAM Disk ( vxWorks ) </td><td>/ram </td><td>RAM:0/ </td><td>Created by the cFE Core. Used to store logs, data files. Preserved on a processor reset. </td></tr>
<tr>
<td>/eedev0 </td><td>File System Mapped ( FS_BASED) </td><td>/cf </td><td>eep:0/ </td><td>The MCP750 Compact Flash disk is used as the Non-Volatile disk for the cFE. It is created/initialized by the BSP and mapped to the cFE in the volume table. </td></tr>
<tr>
<td>/ramdev1 - /ramdev5 </td><td>Real RAM Disk </td><td>N/A </td><td>N/A </td><td>Unused table entries for applications to create new cFE based RAM disks </td></tr>
<tr>
<td>/ssrdev0 - /ssrdev2 </td><td>File System Mapped (FS_BASED) </td><td>N/A </td><td>/ssr:0/SSR1 - /ssr:0/SSR3 </td><td>Unused table entries for applications to map Hard Disk device directories to "pseudo" SSR file systems. </td></tr>
</table>
<center> <h4>How to configure the vxWorks 6.4 BSP to support the cFE </h4>
</center><center> </center><p>The vxWorks 6.4 BSP for the MCP750 is built and configured as a Workbench (Eclipse) vxWorks kernel image project. All of the kernel settings are configured through the Graphical User Interface rather than the traditional "config.h" and "configAll.h" files. The vxWorks kernel image project files for the MCP750 in the <code>arch/ppc/mcp750/vxworks6.4/bsp/bsp-integration</code> directory. To setup a new vxWorks kernel image, do the following:<br />
</p>
<ol>
<li>
Copy the <code> arch/ppc/mcp750/vxworks6.4/bsp/bsp-integration/mcp750 </code> directory to the <code> WindRiver/vxworks6.4/target/config </code> directory in the vxworks installation if it is not already present. </li>
<li>
Copy the <code> arch/ppc/mcp750/vxworks6.4/bsp/bsp-integration/mcp750image </code> to the Workbench (Eclipse) workspace directory. On the cFE development workstation it is located in /opt/workspace. Make sure the file permissions are read and write. The cm system usually makes them read-only. The vxWorks makefiles will fail if the files remain read only. </li>
<li>
Start the WindRiver Workbench IDE and import an existing vxWorks 6.x kernel image project, selecting the workspace/mcp750image project file. Now you should be able to configure and build the vxWorks kernel for the MCP750. </li>
<li>
An alternative to the Workbench IDE kernel configuration is the “vxprj” command line utility. Vxprj can be used to list, add, or remove vxworks parameters to the kernel image project. It can also be used to build the vxworks kernel images. </li>
</ol>
<p>Now that the vxWorks image project is setup, configure the following options for your application:</p>
<ol>
<li>
<p class="startli">In the kernel configuration settings, the USER_RESERVED_MEM macro must be set to be at least as much as the sum of:<br />
<code> #CFE_ES_RESET_AREA_SIZE + (#CFE_ES_RAM_DISK_SECTOR_SIZE * #CFE_ES_RAM_DISK_NUM_SECTORS )+ #CFE_ES_USER_RESERVED_SIZE + 0x100 </code> <br />
( that is just for a few extra variables )<br />
</p>
<p>The #CFE_ES_USER_RESERVED_SIZE can be used to allocate a chunk of memory that gets preserved on a Processor Reset. The cFE Applications can get the address and size of this memory by calling: <br />
<code></code></p>
<p><code> int32 OS_BSPGetUserReservedArea(void *ptrToUserArea, uint32 *SizeOfUserArea); </code></p>
<p>The function prototype is in "os_bsp.h".</p>
<p class="endli"></p>
</li>
<li>
Integrate the support module called cfeSupport.c : This module must be added to the vxWorks BSP. It contains a couple of functions to return the kernel text addresses and it also has the "startCfeCore" routine that will load and start the cFE core. Note: This is already in the vxWorks kernel image project in <code> arch/ppc/mcp750/vxworks6.4/bsp/bsp-integration/mcp750image </code> so you should not have to do this step. </li>
<li>
Create a non-volatile disk. To support the cFE, there must be a non-volatile disk that contains the cFE Core loadable module, startup script, and cFE apps. For the MCP750 there is a Compact Flash disk in the board. The disk is created in the kernel as device: "CF:0". This non-volatile disk device must be mapped to the cFE 'eedev0' device in the file "bsp_voltab.c" ( the entry should already be in the file and the standalone BSP should already mount the CF disk ). In the event a physical EEPROM disk is not available, a vxWorks ROMFS file system, or a hostfs file system could be used. </li>
</ol>
<center> <h4>How to Run the cFE on the MCP750 </h4>
</center><center> </center> <ol>
<li>
Load the kernel. The custom vxWorks kernel is loaded into the MCP750 via TFTP. We use a vxWorks boot image (Rather than the Motorola boot monitor/loader) to boot the MCP750 board, TFTP the "real" kernel to RAM, and execute it. This vxWorks boot image also sets the network settings for the "real" kernel image. On our cFE development system, we keep the loadable vxWorks kernel image in a TFTP directory on the development workstation. So the vxWorks kernel image goes in <code>/tftpboot/cpu1/cfecpu1.st</code>. <code>( $ cp /opt/workspace/mcp750image/default/vxWorks /tftpboot/cpu1/cfecpu1.st )</code> </li>
<li>
Decide what directory will be used to store the cFE Applications and cFE Startup File. In this example, assume that the cFE Applications will be stored in the <code>/cf:0/apps</code> directory, which will be mapped to the "/cf/apps" cFE path. Create the "apps" directory on the non-volatile disk: "/eep:0/apps". </li>
<li>
Copy the "cfe-core.o" loadable module into the non-volatile disk. On the MCP750, this is done simply by FTPing the <code>cfe-core.o</code> file to the target: <pre class="fragment">        $ ftp 192.168.1.4
        ftp&gt; username: target
        ftp&gt; password: password
        ftp&gt;  cd "CF:0"
        ftp&gt; cd "apps"
        ftp&gt; binary
        ftp&gt; put cfe-core.o</pre> </li>
<li>
For this example, also assume that the cFE Startup File is named "cfe_es_startup.scr". Copy the "cfe_es_startup.scr" script into the non-volatile disk "apps" directory, using FTP as well. </li>
<li>
Copy, via FTP, all of the cFE Application ".o" files into the non-volatile disk "apps" directory. Again, the apps can be FTPed to the target compact flash disk. </li>
<li>
<p class="startli">Copy, via FTP, the vxWorks startup script <code>startup.scr</code> to the Compact Flash root directory. This startup script contains the command to start the cFE core when vxWorks is finished booting. The <code>startup.scr</code> file can be found in the <code>build/cpux/exe</code> directory.</p>
<p>The command in the startup.scr to start the cFE core is:</p>
<pre class="fragment">        </pre><p class="endli">Note the new parameters to the "startCfeCore" function. The second parameter is the image ID. It is an arbitrary integer to help identify which cFE image was booted. In a mission with two banks of EEPROM and two copies of the cFE it can be used to identify or verify the bank that is being used. No other runtime decisions are made based on this parameter. The third parameter is the full cFE path and filename of the cFE Startup File. In this example, the name is the same as the previous build. Once there are two banks of EEPROM in operation, this parameter can be used to select which EEPROM disk is used to startup the cFE Applications. </p>
</li>
</ol>
<center> <h4>Exception Handling </h4>
</center><center> </center><p>The <code>ppc/mcp750/vxWorks 6.4</code> port will catch all exceptions, log them, and cause a processor reset.</p>
<center> <h4>BSP Panic </h4>
</center><center> </center><p>If the cFE core startup fails, the generic cFE code will call the #OS_BSPPanic routine. This is a target specific routine. On the MCP750, the default action of the #OS_BSPPanic routine is to exit back to the cFE shell</p>
<center> <h4>Compressed file support </h4>
</center><center> </center><p>The cFE supports loading compressed cFE Application files. The files must be compressed with the "gzip" utility. An example: "&lt;tt&gt;$ gzip ci.o&lt;/tt&gt;". This will produce the file "&lt;tt&gt;ci.o.gz&lt;/tt&gt;". When the cFE code detects the "&lt;tt&gt;.gz&lt;/tt&gt;" file extension, it will uncompress the cFE application when loading it.</p>
<p>Next: <a class="el" href="cfedeploy_3_3.html">BAE RAD750 / vxWorks 6.4 Platform</a> <b>OR</b> <a class="el" href="cfedeploy_4.html">cFE Tools</a> <br />
 Up To: <a class="el" href="cfedeploy_3.html">Target Specific Instructions</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
